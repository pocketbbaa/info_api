package com.kg.platform.controller;

import java.util.List;
import java.util.Set;

import javax.inject.Inject;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.alibaba.fastjson.JSON;
import com.google.common.collect.Lists;
import com.kg.platform.common.idgen.IDGen;
import com.kg.platform.common.aop.BaseControllerNote;
import com.kg.platform.common.context.Result;
import com.kg.platform.common.entity.JsonEntity;
import com.kg.platform.common.exception.ExceptionEnum;
import com.kg.platform.common.lock.Lock;
import com.kg.platform.common.utils.CheckUtils;
import com.kg.platform.common.utils.HtmlUtil;
import com.kg.platform.common.utils.JedisUtils;
import com.kg.platform.common.utils.sensitivefilter.SensitiveFilter;
import com.kg.platform.model.TokenModel;
import com.kg.platform.model.request.SampleRequest;
import com.kg.platform.service.EmailService;
import com.kg.platform.service.SensitiveWordsService;
import com.kg.platform.service.TokenManager;

@Controller
@RequestMapping("api")
public class GlobalApiController extends ApiBaseController {

    private static final Logger logger = LoggerFactory.getLogger(GlobalApiController.class);

    @Inject
    private SensitiveWordsService sensitiveWordsService;

    @Inject
    private IDGen idGenerater;

    @Inject
    private EmailService emailService;

    @Inject
    private JedisUtils jedisUtils;

    @Inject
    private TokenManager tokenManager;

    @RequestMapping("/sendEmailTask")
    public void sendEmailTask() {
        logger.info("-------------执行发送邮件START---------------");

        emailService.emailManage();

        logger.info("-------------执行发送邮件END---------------");

    }

    @RequestMapping(value = "/getToken", produces = "application/json")
    @ResponseBody
    @BaseControllerNote(needCheckToken = false, isLogin = false)
    public JsonEntity getToken(@RequestParam(required = false, defaultValue = "123123123") String userId) {
        TokenModel model = tokenManager.createToken(Long.parseLong(userId));

        logger.info("创建的token：{}", JSON.toJSONString(model));
        return JsonEntity.makeSuccessJsonEntity(model);
    }

    @ResponseBody
    @RequestMapping("/getUserTokens")
    @BaseControllerNote()
    public JsonEntity getUserTokens() {
        Set<String> userKeys = jedisUtils.keys("*userTokenKey*");
        List<String> userTokens = Lists.newArrayList();
        if (userKeys != null && userKeys.size() > 0) {
            for (String s : userKeys) {
                userTokens.add(s + "_" + (jedisUtils.getSingle(s)));
            }
        }

        if (null != userTokens) {
            return JsonEntity.makeSuccessJsonEntity(userTokens);
        }
        return JsonEntity.makeExceptionJsonEntity(ExceptionEnum.DATAERROR.getCode(),
                ExceptionEnum.DATAERROR.getMessage());

    }

    @ResponseBody
    @RequestMapping("/logTest")
    @BaseControllerNote(beanClazz = SampleRequest.class)
    public JsonEntity logTest(@RequestAttribute SampleRequest request) {

        Lock lock = new Lock();
        try {

            long startTime = System.currentTimeMillis();
            // sendSms.send("13183814258,18683370434", "【KG财经】来自KG财经的测试短信");

            // sendSms.sendInternationalMessage("8613183814258,8618683370434",
            // "【KG财经】来自KG财经的国际短信");

            logger.info("lock................." + startTime);

            lock.lock(String.valueOf(startTime));

            logger.info(JSON.toJSONString(request) + request.getTestreq());

            logger.info(propertyLoader.getProperty("message", "mail.subject"));

            // logger.info(JSON.toJSONString(sensitiveWordsService.getAllSensitiveWords()));

            Result<SensitiveFilter> filterResult = sensitiveWordsService.getSensitiveFilter();

            if (CheckUtils.checkRetInfo(filterResult, true)) {
                SensitiveFilter filter = filterResult.getData();

                // 待过滤的句子
                String sentence = "<!DOCTYPE html><html lang=\"zh-cn\"><head><meta charset=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" /><title>Spring Boot 整合 Elasticsearch，实现 function score query 权重分查询 - 泥瓦匠BYSocket - 博客园</title><link type=\"text/css\" rel=\"stylesheet\" href=\"/bundles/blog-common.css?v=ChDk9h03-S75WEqNhGvXkWireJ5cCWdK1xRM9NIXfnM1\"/><link id=\"MainCss\" type=\"text/css\" rel=\"stylesheet\" href=\"/skins/CodingLife/bundle-CodingLife.css?v=Kn6KiDd259SBCz5TLORaQ9SBElF985T0TAIl-BjTtws1\"/><link id=\"mobile-style\" media=\"only screen and (max-width: 767px)\" type=\"text/css\" rel=\"stylesheet\" href=\"/skins/CodingLife/bundle-CodingLife-mobile.css?v=Xay8b9tTSw814nBzbOgvS6rrbcxrobMhvHJHdZAO9vI1\"/><link title=\"RSS\" type=\"application/rss+xml\" rel=\"alternate\" href=\"http://www.cnblogs.com/Alandre/rss\"/><link title=\"RSD\" type=\"application/rsd+xml\" rel=\"EditURI\" href=\"http://www.cnblogs.com/Alandre/rsd.xml\"/><link type=\"application/wlwmanifest+xml\" rel=\"wlwmanifest\" href=\"http://www.cnblogs.com/Alandre/wlwmanifest.xml\"/><script src=\"//common.cnblogs.com/script/jquery.js\" type=\"text/javascript\"></script>  <script type=\"text/javascript\">var currentBlogApp = 'Alandre', cb_enable_mathjax=true;var isLogined=false;</script><script src=\"/bundles/blog-common.js?v=7RA_FyMZc2FeSt0PudYSR_a-R9OGIHQbo-m4rDq2G3A1\" type=\"text/javascript\"></script></head><body><a name=\"top\"></a><!--PageBeginHtml Block Begin--><a href=\"https://github.com/JeffLi1993\" target=\"_blank\"><img style=\"position: absolute; top: 35px; right: 0; border: 0; position: fixed;\" src=\"https://camo.githubusercontent.com/52760788cde945287fbb584134c4cbc2bc36f904/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67\" alt=\"Fork me on GitHub\" data-canonical-src=\"https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png\"></a><!--PageBeginHtml Block End--><!--done--><div id=\"home\"><div id=\"header\"> <div id=\"blogTitle\">  <a id=\"lnkBlogLogo\" href=\"http://www.cnblogs.com/Alandre/\"><img id=\"blogLogo\" src=\"/Skins/custom/images/logo.gif\" alt=\"返回主页\" /></a>                   <!--done--><h1><a id=\"Header1_HeaderTitle\" class=\"headermaintitle\" href=\"http://www.cnblogs.com/Alandre/\">泥瓦匠BYSocket</a></h1><h2></h2>           </div><!--end: blogTitle 博客的标题和副标题 -->  <div id=\"navigator\">      <ul id=\"navList\"><li><a id=\"blog_nav_sitehome\" class=\"menu\" href=\"http://www.cnblogs.com/\">博客园</a></li><li><a id=\"blog_nav_myhome\" class=\"menu\" href=\"http://www.cnblogs.com/Alandre/\">首页</a></li><li></li><li><a id=\"blog_nav_contact\" class=\"menu\" rel=\"nofollow\" href=\"https://msg.cnblogs.com/send/%E6%B3%A5%E7%93%A6%E5%8C%A0BYSocket\">联系</a></li><li><a id=\"blog_nav_rss\" class=\"menu\" href=\"http://www.cnblogs.com/Alandre/rss\">订阅</a><!--<a id=\"blog_nav_rss_image\" class=\"aHeaderXML\" href=\"http://www.cnblogs.com/Alandre/rss\"><img src=\"//www.cnblogs.com/images/xml.gif\" alt=\"订阅\" /></a>--></li><li><a id=\"blog_nav_admin\" class=\"menu\" rel=\"nofollow\" href=\"https://i.cnblogs.com/\">管理</a></li></ul>     <div class=\"blogStats\">                       <div id=\"blog_stats\"><span id=\"stats_post_count\">随笔 - 285&nbsp; </span><span id=\"stats_article_count\">文章 - 0&nbsp; </span><span id=\"stats-comment_count\">评论 - 477</span></div>                  </div><!--end: blogStats -->    </div><!--end: navigator 博客导航栏 --></div><!--end: header 头部 --><div id=\"main\"> <div id=\"mainContent\">    <div class=\"forFlow\">     <div id=\"post_detail\"><!--done--><div id=\"topics\">  <div class = \"post\">      <h1 class = \"postTitle\">          <a id=\"cb_post_title_url\" class=\"postTitle2\" href=\"http://www.cnblogs.com/Alandre/p/6877512.html\">Spring Boot 整合 Elasticsearch，实现 function score query 权重分查询</a>      </h1>       <div class=\"clear\"></div>     <div class=\"postBody\">            <div id=\"cnblogs_post_body\"><p>摘要: 原创出处 www.bysocket.com 「泥瓦匠BYSocket 」欢迎转载，保留摘要，谢谢！</p><p>『 预见未来最好的方式就是亲手创造未来 &ndash; 《史蒂夫&middot;乔布斯传》 』</p><p><strong>运行环境</strong>：JDK 7 或 8，Maven 3.0+<br /><strong>技术栈</strong>：SpringBoot 1.5+，ElasticSearch 2.3.2</p><p><strong>本文提纲</strong><br />一、ES 的使用场景<br />二、运行 springboot-elasticsearch 工程<br />三、springboot-elasticsearch 工程代码详解</p><h3>一、ES 的使用场景</h3><p>简单说，ElasticSearch（简称 ES）是搜索引擎，是结构化数据的分布式搜索引擎。在《<a href=\"http://www.bysocket.com/?p=1744\">Elasticsearch 和插件 elasticsearch-head 安装详解</a>》 &nbsp;和 《<a href=\"http://www.bysocket.com/?p=1798\">Elasticsearch 默认配置 IK 及 Java AnalyzeRequestBuilder 使用</a>》 我详细的介绍了如何安装，初步使用了 IK 分词器。这里，我主要讲下 SpringBoot 工程中如何使用 ElasticSearch。</p><p>ES 的使用场景大致分为两块<br />1. 全文检索。加上分词（IK 是其中一个）、拼音插件等可以成为强大的全文搜索引擎。<br />2. 日志统计分析。可以实时动态分析海量日志数据。</p><h3>二、运行 springboot-elasticsearch 工程</h3><p>注意的是这里使用的是 ElasticSearch 2.3.2。是因为<a href=\"https://github.com/spring-projects/spring-data-elasticsearch/wiki/Spring-Data-Elasticsearch---Spring-Boot---version-matrix\">版本对应关系</a>&nbsp;：</p><div><div id=\"highlighter_540774\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">Spring Boot Version (x) Spring Data Elasticsearch Version (y) Elasticsearch Version (z)</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">x &lt;= 1.3.5 y &lt;= 1.3.4 z &lt;= 1.7.2* x &gt;= 1.4.x 2.0.0 &lt;=y &lt; 5.0.0** 2.0.0 &lt;= z &lt; 5.0.0**</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell plain\">* - 只需要你修改下对应的 pom 文件版本号</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell plain\">** - 下一个 ES 的版本会有重大的更新</code></div></div></td></tr></tbody></table></div></div><p>git clone 下载工程 springboot-elasticsearch ，项目地址见 GitHub &ndash; https://github.com/JeffLi1993/springboot-learning-example。</p><p>1. 后台起守护线程启动 Elasticsearch</p><div><div id=\"highlighter_49757\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell functions\">cd</code> <code class=\"shell plain\">elasticsearch-2.3.2/</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">.</code><code class=\"shell plain\">/bin/elasticsearch</code> <code class=\"shell plain\">-d</code></div></div></td></tr></tbody></table></div></div><p>下面开始运行工程步骤（Quick Start）：</p><p>2. 项目结构介绍</p><div><div id=\"highlighter_704955\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">org.spring.springboot.controller - Controller 层</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">org.spring.springboot.repository - ES 数据操作层</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell plain\">org.spring.springboot.domain - 实体类</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell plain\">org.spring.springboot.service - ES 业务逻辑层</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell plain\">Application - 应用启动类</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell plain\">application.properties - 应用配置文件，应用启动会自动读取配置</code></div></div></td></tr></tbody></table></div></div><p>本地启动的 ES ，就不需要改配置文件了。如果连测试 ES 服务地址，需要修改相应配置</p><p>3.编译工程<br />在项目根目录 springboot-elasticsearch，运行 maven 指令：</p><div><div id=\"highlighter_836791\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">mvn clean </code><code class=\"shell functions\">install</code></div></div></td></tr></tbody></table></div></div><p>4.运行工程<br />右键运行 Application 应用启动类（位置：/springboot-learning-example/springboot-elasticsearch/src/main/java/org/spring/springboot/Application.java）的 main 函数，这样就成功启动了 springboot-elasticsearch 案例。</p><p>用 Postman 工具新增两个城市<br />新增城市信息</p><div><div id=\"highlighter_595088\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div><div class=\"line number15 index14 alt2\">15</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">POST http:</code><code class=\"shell plain\">//127</code><code class=\"shell plain\">.0.0.1:8080</code><code class=\"shell plain\">/api/city</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">{</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell string\">\"id\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"1\"</code><code class=\"shell plain\">,</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell string\">\"provinceid\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"1\"</code><code class=\"shell plain\">,</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"温岭\"</code><code class=\"shell plain\">,</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"温岭是个好城市\"</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number8 index7 alt1\">&nbsp;</div><div class=\"line number9 index8 alt2\"><code class=\"shell plain\">POST http:</code><code class=\"shell plain\">//127</code><code class=\"shell plain\">.0.0.1:8080</code><code class=\"shell plain\">/api/city</code></div><div class=\"line number10 index9 alt1\"><code class=\"shell plain\">{</code></div><div class=\"line number11 index10 alt2\"><code class=\"shell string\">\"id\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"2\"</code><code class=\"shell plain\">,</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell string\">\"provinceid\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"2\"</code><code class=\"shell plain\">,</code></div><div class=\"line number13 index12 alt2\"><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"温州\"</code><code class=\"shell plain\">,</code></div><div class=\"line number14 index13 alt1\"><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">:</code><code class=\"shell string\">\"温州是个热城市\"</code></div><div class=\"line number15 index14 alt2\"><code class=\"shell plain\">}</code></div></div></td></tr></tbody></table></div></div><p>可以打开 ES 可视化工具 head 插件：http://localhost:9200/_plugin/head/：<br />（如果不知道怎么安装，请查阅 《<a href=\"http://www.bysocket.com/?p=1744\">Elasticsearch 和插件 elasticsearch-head 安装详解</a>》 。）<br />在「数据浏览」tab，可以查阅到 ES 中数据是否被插入，插入后的数据格式如下：</p><div><div id=\"highlighter_479253\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">{</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell string\">\"_index\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"cityindex\"</code><code class=\"shell plain\">,</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell string\">\"_type\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"city\"</code><code class=\"shell plain\">,</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell string\">\"_id\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"1\"</code><code class=\"shell plain\">,</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell string\">\"_version\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell string\">\"_score\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell string\">\"_source\"</code><code class=\"shell plain\">: {</code></div><div class=\"line number8 index7 alt1\"><code class=\"shell string\">\"id\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number9 index8 alt2\"><code class=\"shell string\">\"provinceid\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number10 index9 alt1\"><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭\"</code><code class=\"shell plain\">,</code></div><div class=\"line number11 index10 alt2\"><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭是个好城市\"</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number13 index12 alt2\"><code class=\"shell plain\">}</code></div></div></td></tr></tbody></table></div></div><p>下面验证下权重分查询搜索接口的实现：<br />GET http://localhost:8080/api/city/search?pageNumber=0&amp;pageSize=10&amp;searchContent=温岭<br />数据是会出现</p><div><div id=\"highlighter_103193\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">[</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">{</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell string\">\"id\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell string\">\"provinceid\"</code><code class=\"shell plain\">: 1,</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭\"</code><code class=\"shell plain\">,</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭是个好城市\"</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell plain\">},</code></div><div class=\"line number8 index7 alt1\"><code class=\"shell plain\">{</code></div><div class=\"line number9 index8 alt2\"><code class=\"shell string\">\"id\"</code><code class=\"shell plain\">: 2,</code></div><div class=\"line number10 index9 alt1\"><code class=\"shell string\">\"provinceid\"</code><code class=\"shell plain\">: 2,</code></div><div class=\"line number11 index10 alt2\"><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温州\"</code><code class=\"shell plain\">,</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">: </code><code class=\"shell string\">\"温州是个热城市\"</code></div><div class=\"line number13 index12 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number14 index13 alt1\"><code class=\"shell plain\">]</code></div></div></td></tr></tbody></table></div></div><p>从启动后台 Console 可以看出，打印出来对应的 DSL 语句：</p><div><div id=\"highlighter_601392\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div><div class=\"line number15 index14 alt2\">15</div><div class=\"line number16 index15 alt1\">16</div><div class=\"line number17 index16 alt2\">17</div><div class=\"line number18 index17 alt1\">18</div><div class=\"line number19 index18 alt2\">19</div><div class=\"line number20 index19 alt1\">20</div><div class=\"line number21 index20 alt2\">21</div><div class=\"line number22 index21 alt1\">22</div><div class=\"line number23 index22 alt2\">23</div><div class=\"line number24 index23 alt1\">24</div><div class=\"line number25 index24 alt2\">25</div><div class=\"line number26 index25 alt1\">26</div><div class=\"line number27 index26 alt2\">27</div><div class=\"line number28 index27 alt1\">28</div><div class=\"line number29 index28 alt2\">29</div><div class=\"line number30 index29 alt1\">30</div><div class=\"line number31 index30 alt2\">31</div><div class=\"line number32 index31 alt1\">32</div><div class=\"line number33 index32 alt2\">33</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">{</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell string\">\"function_score\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell string\">\"functions\"</code> <code class=\"shell plain\">: [ {</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell string\">\"filter\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell string\">\"bool\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell string\">\"should\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell string\">\"match\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number8 index7 alt1\"><code class=\"shell string\">\"cityname\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number9 index8 alt2\"><code class=\"shell string\">\"query\"</code> <code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭\"</code><code class=\"shell plain\">,</code></div><div class=\"line number10 index9 alt1\"><code class=\"shell string\">\"type\"</code> <code class=\"shell plain\">: </code><code class=\"shell string\">\"boolean\"</code></div><div class=\"line number11 index10 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number13 index12 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number14 index13 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number15 index14 alt2\"><code class=\"shell plain\">},</code></div><div class=\"line number16 index15 alt1\"><code class=\"shell string\">\"weight\"</code> <code class=\"shell plain\">: 1000.0</code></div><div class=\"line number17 index16 alt2\"><code class=\"shell plain\">}, {</code></div><div class=\"line number18 index17 alt1\"><code class=\"shell string\">\"filter\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number19 index18 alt2\"><code class=\"shell string\">\"bool\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number20 index19 alt1\"><code class=\"shell string\">\"should\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number21 index20 alt2\"><code class=\"shell string\">\"match\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number22 index21 alt1\"><code class=\"shell string\">\"description\"</code> <code class=\"shell plain\">: {</code></div><div class=\"line number23 index22 alt2\"><code class=\"shell string\">\"query\"</code> <code class=\"shell plain\">: </code><code class=\"shell string\">\"温岭\"</code><code class=\"shell plain\">,</code></div><div class=\"line number24 index23 alt1\"><code class=\"shell string\">\"type\"</code> <code class=\"shell plain\">: </code><code class=\"shell string\">\"boolean\"</code></div><div class=\"line number25 index24 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number26 index25 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number27 index26 alt2\"><code class=\"shell plain\">}</code></div><div class=\"line number28 index27 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number29 index28 alt2\"><code class=\"shell plain\">},</code></div><div class=\"line number30 index29 alt1\"><code class=\"shell string\">\"weight\"</code> <code class=\"shell plain\">: 100.0</code></div><div class=\"line number31 index30 alt2\"><code class=\"shell plain\">} ]</code></div><div class=\"line number32 index31 alt1\"><code class=\"shell plain\">}</code></div><div class=\"line number33 index32 alt2\"><code class=\"shell plain\">}</code></div></div></td></tr></tbody></table></div></div><p>为什么会出现 温州 城市呢？因为 function score query 权重分查询，无相关的数据默认分值为 1。如果想除去，设置一个 setMinScore 分值即可。</p><h3>三、springboot-elasticsearch 工程代码详解</h3><p>具体代码见&nbsp;<a href=\"https://github.com/JeffLi1993/springboot-learning-example\">GitHub</a>&nbsp;&ndash;&nbsp;<a href=\"https://github.com/JeffLi1993/springboot-learning-example\">https://github.com/JeffLi1993/springboot-learning-example</a><br />1.pom.xml 依赖</p><div><div id=\"highlighter_153056\" class=\"syntaxhighlighter  xml\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div><div class=\"line number15 index14 alt2\">15</div><div class=\"line number16 index15 alt1\">16</div><div class=\"line number17 index16 alt2\">17</div><div class=\"line number18 index17 alt1\">18</div><div class=\"line number19 index18 alt2\">19</div><div class=\"line number20 index19 alt1\">20</div><div class=\"line number21 index20 alt2\">21</div><div class=\"line number22 index21 alt1\">22</div><div class=\"line number23 index22 alt2\">23</div><div class=\"line number24 index23 alt1\">24</div><div class=\"line number25 index24 alt2\">25</div><div class=\"line number26 index25 alt1\">26</div><div class=\"line number27 index26 alt2\">27</div><div class=\"line number28 index27 alt1\">28</div><div class=\"line number29 index28 alt2\">29</div><div class=\"line number30 index29 alt1\">30</div><div class=\"line number31 index30 alt2\">31</div><div class=\"line number32 index31 alt1\">32</div><div class=\"line number33 index32 alt2\">33</div><div class=\"line number34 index33 alt1\">34</div><div class=\"line number35 index34 alt2\">35</div><div class=\"line number36 index35 alt1\">36</div><div class=\"line number37 index36 alt2\">37</div><div class=\"line number38 index37 alt1\">38</div><div class=\"line number39 index38 alt2\">39</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"xml plain\">&lt;?</code><code class=\"xml keyword\">xml</code> <code class=\"xml color1\">version</code><code class=\"xml plain\">=</code><code class=\"xml string\">\"1.0\"</code> <code class=\"xml color1\">encoding</code><code class=\"xml plain\">=</code><code class=\"xml string\">\"UTF-8\"</code><code class=\"xml plain\">?&gt;</code></div><div class=\"line number2 index1 alt1\"><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">project</code> <code class=\"xml color1\">xmlns</code><code class=\"xml plain\">=</code><code class=\"xml string\">\"http://maven.apache.org/POM/4.0.0\"</code> <code class=\"xml color1\">xmlns:xsi</code><code class=\"xml plain\">=</code><code class=\"xml string\">\"http://www.w3.org/2001/XMLSchema-instance\"</code></div><div class=\"line number3 index2 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml color1\">xsi:schemaLocation</code><code class=\"xml plain\">=</code><code class=\"xml string\">\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number4 index3 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">modelVersion</code><code class=\"xml plain\">&gt;4.0.0&lt;/</code><code class=\"xml keyword\">modelVersion</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number5 index4 alt2\">&nbsp;</div><div class=\"line number6 index5 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;springboot&lt;/</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number7 index6 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;springboot-elasticsearch&lt;/</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number8 index7 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;0.0.1-SNAPSHOT&lt;/</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number9 index8 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">name</code><code class=\"xml plain\">&gt;springboot-elasticsearch :: 整合 Elasticsearch &lt;/</code><code class=\"xml keyword\">name</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number10 index9 alt1\">&nbsp;</div><div class=\"line number11 index10 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml comments\">&lt;!-- Spring Boot 启动父依赖 --&gt;</code></div><div class=\"line number12 index11 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">parent</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number13 index12 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;org.springframework.boot&lt;/</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number14 index13 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;spring-boot-starter-parent&lt;/</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number15 index14 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;1.5.1.RELEASE&lt;/</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number16 index15 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">parent</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number17 index16 alt2\">&nbsp;</div><div class=\"line number18 index17 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">dependencies</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number19 index18 alt2\">&nbsp;</div><div class=\"line number20 index19 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml comments\">&lt;!-- Spring Boot Elasticsearch 依赖 --&gt;</code></div><div class=\"line number21 index20 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number22 index21 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;org.springframework.boot&lt;/</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number23 index22 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;spring-boot-starter-data-elasticsearch&lt;/</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number24 index23 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number25 index24 alt2\">&nbsp;</div><div class=\"line number26 index25 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml comments\">&lt;!-- Spring Boot Web 依赖 --&gt;</code></div><div class=\"line number27 index26 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number28 index27 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;org.springframework.boot&lt;/</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number29 index28 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;spring-boot-starter-web&lt;/</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number30 index29 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number31 index30 alt2\">&nbsp;</div><div class=\"line number32 index31 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml comments\">&lt;!-- Junit --&gt;</code></div><div class=\"line number33 index32 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number34 index33 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;junit&lt;/</code><code class=\"xml keyword\">groupId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number35 index34 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;junit&lt;/</code><code class=\"xml keyword\">artifactId</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number36 index35 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;4.12&lt;/</code><code class=\"xml keyword\">version</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number37 index36 alt2\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">dependency</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number38 index37 alt1\"><code class=\"xml spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">dependencies</code><code class=\"xml plain\">&gt;</code></div><div class=\"line number39 index38 alt2\"><code class=\"xml plain\">&lt;/</code><code class=\"xml keyword\">project</code><code class=\"xml plain\">&gt;</code></div></div></td></tr></tbody></table></div></div><p>这里依赖的 spring-boot-starter-data-elasticsearch 版本是 1.5.1.RELEASE，对应的 spring-data-elasticsearch 版本是 2.1.0.RELEASE。后面数据操作层都是通过该 spring-data-elasticsearch 提供的接口实现。</p><p>操作对应<a href=\"http://docs.spring.io/spring-data/elasticsearch/docs/2.1.0.RELEASE/reference/html/\">官方文档</a>：http://docs.spring.io/spring-data/elasticsearch/docs/2.1.0.RELEASE/reference/html/。</p><p>2. application.properties 配置 ES 地址</p><div><div id=\"highlighter_343295\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell comments\"># ES</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">spring.data.elasticsearch.repositories.enabled = </code><code class=\"shell functions\">true</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell plain\">spring.data.elasticsearch.cluster-nodes = 127.0.0.1:9300</code></div></div></td></tr></tbody></table></div></div><p>默认 9300 是 Java 客户端的端口。9200 是支持 Restful HTTP 的接口。<br />更多配置：</p><div><div id=\"highlighter_31584\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">spring.data.elasticsearch.cluster-name Elasticsearch 集群名。(默认值: elasticsearch)</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">spring.data.elasticsearch.cluster-nodes 集群节点地址列表，用逗号分隔。如果没有指定，就启动一个客户端节点。</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell plain\">spring.data.elasticsearch.propertie 用来配置客户端的额外属性。</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell plain\">spring.data.elasticsearch.repositories.enabled 开启 Elasticsearch 仓库。(默认值:</code><code class=\"shell functions\">true</code><code class=\"shell plain\">。)</code></div></div></td></tr></tbody></table></div></div><p>3. ES 数据操作层</p><div><div id=\"highlighter_428505\" class=\"syntaxhighlighter  java\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"java color1\">@Repository</code></div><div class=\"line number2 index1 alt1\"><code class=\"java keyword\">public</code> <code class=\"java keyword\">interface</code> <code class=\"java plain\">CityRepository </code><code class=\"java keyword\">extends</code> <code class=\"java plain\">ElasticsearchRepository&lt;City,Long&gt; {</code></div><div class=\"line number3 index2 alt2\">&nbsp;</div><div class=\"line number4 index3 alt1\">&nbsp;</div><div class=\"line number5 index4 alt2\"><code class=\"java plain\">}</code></div></div></td></tr></tbody></table></div></div><p>接口只要继承 ElasticsearchRepository 类即可。默认会提供很多实现，比如 CRUD 和搜索相关的实现。</p><p>4. 实体类</p><div><div id=\"highlighter_843408\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div><div class=\"line number15 index14 alt2\">15</div><div class=\"line number16 index15 alt1\">16</div><div class=\"line number17 index16 alt2\">17</div><div class=\"line number18 index17 alt1\">18</div><div class=\"line number19 index18 alt2\">19</div><div class=\"line number20 index19 alt1\">20</div><div class=\"line number21 index20 alt2\">21</div><div class=\"line number22 index21 alt1\">22</div><div class=\"line number23 index22 alt2\">23</div><div class=\"line number24 index23 alt1\">24</div><div class=\"line number25 index24 alt2\">25</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">@Document(indexName = </code><code class=\"shell string\">\"cityindex\"</code><code class=\"shell plain\">, </code><code class=\"shell functions\">type</code> <code class=\"shell plain\">= </code><code class=\"shell string\">\"city\"</code><code class=\"shell plain\">)</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell plain\">public class City implements Serializable{</code></div><div class=\"line number3 index2 alt2\">&nbsp;</div><div class=\"line number4 index3 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private static final long serialVersionUID = -1L;</code></div><div class=\"line number5 index4 alt2\">&nbsp;</div><div class=\"line number6 index5 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">/**</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">* 城市编号</code></div><div class=\"line number8 index7 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">*/</code></div><div class=\"line number9 index8 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private Long </code><code class=\"shell functions\">id</code><code class=\"shell plain\">;</code></div><div class=\"line number10 index9 alt1\">&nbsp;</div><div class=\"line number11 index10 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">/**</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">* 省份编号</code></div><div class=\"line number13 index12 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">*/</code></div><div class=\"line number14 index13 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private Long provinceid;</code></div><div class=\"line number15 index14 alt2\">&nbsp;</div><div class=\"line number16 index15 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">/**</code></div><div class=\"line number17 index16 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">* 城市名称</code></div><div class=\"line number18 index17 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">*/</code></div><div class=\"line number19 index18 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private String cityname;</code></div><div class=\"line number20 index19 alt1\">&nbsp;</div><div class=\"line number21 index20 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">/**</code></div><div class=\"line number22 index21 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">* 描述</code></div><div class=\"line number23 index22 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">*/</code></div><div class=\"line number24 index23 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private String description;</code></div><div class=\"line number25 index24 alt2\"><code class=\"shell plain\">}</code></div></div></td></tr></tbody></table></div></div><p>注意<br />index 配置必须是全部小写，不然会暴异常。<br />org.elasticsearch.indices.InvalidIndexNameException: Invalid index name [cityIndex], must be lowercase</p><p>5. ES 业务逻辑层</p><div><div id=\"highlighter_821729\" class=\"syntaxhighlighter  shell\"><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"><tbody><tr><td class=\"gutter\"><div class=\"line number1 index0 alt2\">1</div><div class=\"line number2 index1 alt1\">2</div><div class=\"line number3 index2 alt2\">3</div><div class=\"line number4 index3 alt1\">4</div><div class=\"line number5 index4 alt2\">5</div><div class=\"line number6 index5 alt1\">6</div><div class=\"line number7 index6 alt2\">7</div><div class=\"line number8 index7 alt1\">8</div><div class=\"line number9 index8 alt2\">9</div><div class=\"line number10 index9 alt1\">10</div><div class=\"line number11 index10 alt2\">11</div><div class=\"line number12 index11 alt1\">12</div><div class=\"line number13 index12 alt2\">13</div><div class=\"line number14 index13 alt1\">14</div><div class=\"line number15 index14 alt2\">15</div><div class=\"line number16 index15 alt1\">16</div><div class=\"line number17 index16 alt2\">17</div><div class=\"line number18 index17 alt1\">18</div><div class=\"line number19 index18 alt2\">19</div><div class=\"line number20 index19 alt1\">20</div><div class=\"line number21 index20 alt2\">21</div><div class=\"line number22 index21 alt1\">22</div><div class=\"line number23 index22 alt2\">23</div><div class=\"line number24 index23 alt1\">24</div><div class=\"line number25 index24 alt2\">25</div><div class=\"line number26 index25 alt1\">26</div><div class=\"line number27 index26 alt2\">27</div><div class=\"line number28 index27 alt1\">28</div><div class=\"line number29 index28 alt2\">29</div><div class=\"line number30 index29 alt1\">30</div><div class=\"line number31 index30 alt2\">31</div><div class=\"line number32 index31 alt1\">32</div><div class=\"line number33 index32 alt2\">33</div><div class=\"line number34 index33 alt1\">34</div><div class=\"line number35 index34 alt2\">35</div><div class=\"line number36 index35 alt1\">36</div><div class=\"line number37 index36 alt2\">37</div><div class=\"line number38 index37 alt1\">38</div><div class=\"line number39 index38 alt2\">39</div><div class=\"line number40 index39 alt1\">40</div><div class=\"line number41 index40 alt2\">41</div><div class=\"line number42 index41 alt1\">42</div><div class=\"line number43 index42 alt2\">43</div><div class=\"line number44 index43 alt1\">44</div><div class=\"line number45 index44 alt2\">45</div><div class=\"line number46 index45 alt1\">46</div></td><td class=\"code\"><div class=\"container\"><div class=\"line number1 index0 alt2\"><code class=\"shell plain\">/**</code></div><div class=\"line number2 index1 alt1\"><code class=\"shell spaces\">&nbsp;</code><code class=\"shell plain\">* 城市 ES 业务逻辑实现类</code></div><div class=\"line number3 index2 alt2\"><code class=\"shell spaces\">&nbsp;</code><code class=\"shell plain\">*</code></div><div class=\"line number4 index3 alt1\"><code class=\"shell spaces\">&nbsp;</code><code class=\"shell plain\">* Created by bysocket on 07</code><code class=\"shell plain\">/02/2017</code><code class=\"shell plain\">.</code></div><div class=\"line number5 index4 alt2\"><code class=\"shell spaces\">&nbsp;</code><code class=\"shell plain\">*/</code></div><div class=\"line number6 index5 alt1\"><code class=\"shell plain\">@Service</code></div><div class=\"line number7 index6 alt2\"><code class=\"shell plain\">public class CityESServiceImpl implements CityService {</code></div><div class=\"line number8 index7 alt1\">&nbsp;</div><div class=\"line number9 index8 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">private static final Logger LOGGER = LoggerFactory.getLogger(CityESServiceImpl.class);</code></div><div class=\"line number10 index9 alt1\">&nbsp;</div><div class=\"line number11 index10 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">@Autowired</code></div><div class=\"line number12 index11 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">CityRepository cityRepository;</code></div><div class=\"line number13 index12 alt2\">&nbsp;</div><div class=\"line number14 index13 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">@Override</code></div><div class=\"line number15 index14 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">public Long saveCity(City city) {</code></div><div class=\"line number16 index15 alt1\">&nbsp;</div><div class=\"line number17 index16 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">City cityResult = cityRepository.save(city);</code></div><div class=\"line number18 index17 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell keyword\">return</code> <code class=\"shell plain\">cityResult.getId();</code></div><div class=\"line number19 index18 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">}</code></div><div class=\"line number20 index19 alt1\">&nbsp;</div><div class=\"line number21 index20 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">@Override</code></div><div class=\"line number22 index21 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">public List&lt;City&gt; searchCity(Integer pageNumber,</code></div><div class=\"line number23 index22 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">Integer pageSize,</code></div><div class=\"line number24 index23 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">String searchContent) {</code></div><div class=\"line number25 index24 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">//</code> <code class=\"shell plain\">分页参数</code></div><div class=\"line number26 index25 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">Pageable pageable = new PageRequest(pageNumber, pageSize);</code></div><div class=\"line number27 index26 alt2\">&nbsp;</div><div class=\"line number28 index27 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">//</code> <code class=\"shell plain\">Function Score Query</code></div><div class=\"line number29 index28 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">FunctionScoreQueryBuilder functionScoreQueryBuilder = QueryBuilders.functionScoreQuery()</code></div><div class=\"line number30 index29 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">.add(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery(</code><code class=\"shell string\">\"cityname\"</code><code class=\"shell plain\">, searchContent)),</code></div><div class=\"line number31 index30 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">ScoreFunctionBuilders.weightFactorFunction(1000))</code></div><div class=\"line number32 index31 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">.add(QueryBuilders.boolQuery().should(QueryBuilders.matchQuery(</code><code class=\"shell string\">\"description\"</code><code class=\"shell plain\">, searchContent)),</code></div><div class=\"line number33 index32 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">ScoreFunctionBuilders.weightFactorFunction(100));</code></div><div class=\"line number34 index33 alt1\">&nbsp;</div><div class=\"line number35 index34 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">//</code> <code class=\"shell plain\">创建搜索 DSL 查询</code></div><div class=\"line number36 index35 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">SearchQuery searchQuery = new NativeSearchQueryBuilder()</code></div><div class=\"line number37 index36 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">.withPageable(pageable)</code></div><div class=\"line number38 index37 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">.withQuery(functionScoreQueryBuilder).build();</code></div><div class=\"line number39 index38 alt2\">&nbsp;</div><div class=\"line number40 index39 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">LOGGER.info(</code><code class=\"shell string\">\"\n searchCity(): searchContent [\"</code> <code class=\"shell plain\">+ searchContent + </code><code class=\"shell string\">\"] \n DSL&nbsp; = \n \"</code> <code class=\"shell plain\">+ searchQuery.getQuery().toString());</code></div><div class=\"line number41 index40 alt2\">&nbsp;</div><div class=\"line number42 index41 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">Page&lt;City&gt; searchPageResults = cityRepository.search(searchQuery);</code></div><div class=\"line number43 index42 alt2\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell keyword\">return</code> <code class=\"shell plain\">searchPageResults.getContent();</code></div><div class=\"line number44 index43 alt1\"><code class=\"shell spaces\">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class=\"shell plain\">}</code></div><div class=\"line number45 index44 alt2\">&nbsp;</div><div class=\"line number46 index45 alt1\"><code class=\"shell plain\">}</code></div></div></td></tr></tbody></table></div></div><p>保存逻辑很简单。</p><p>分页 function score query 搜索逻辑如下：</p><p>先创建分页参数，然后用 FunctionScoreQueryBuilder 定义 Function Score Query，并设置对应字段的权重分值。城市名称 1000 分，description 100 分。<br />然后创建该搜索的 DSL 查询，并打印出来。</p><h3>四、小结</h3><p>实际场景还会很复杂。这里只是点睛之笔，后续大家优化或者更改下 DSL 语句就可以完成自己想要的搜索规则。</p><p>推荐：《<a href=\"http://www.bysocket.com/?p=1681\">Spring Boot 整合 Dubbo/ZooKeeper 详解 SOA 案例</a>》<br />上一篇：《<a href=\"http://www.bysocket.com/?p=1811\" rel=\"bookmark\">Spring Boot 整合 Mybatis Annotation 注解案例</a>》</p><p>欢迎扫一扫我的公众号关注 &mdash; 及时得到博客订阅哦！<br />&mdash;&nbsp;<a href=\"http://www.bysocket.com/\">http://www.bysocket.com/</a>&nbsp;&mdash;<br />&mdash;&nbsp;<a href=\"https://github.com/JeffLi1993\">https://github.com/JeffLi1993</a>&nbsp;&mdash;</p><p><a href=\"http://www.bysocket.com/wp-content/uploads/2017/01/qrcode_for_gh_cd421e7eb7d6_430.jpg\"><img class=\"alignnone  wp-image-1551\" src=\"http://www.bysocket.com/wp-content/uploads/2017/01/qrcode_for_gh_cd421e7eb7d6_430.jpg\" alt=\"\" width=\"312\" height=\"312\" data-bd-imgshare-binded=\"1\" /></a></p></div><div id=\"MySignature\"></div><div class=\"clear\"></div><div id=\"blog_post_info_block\"><div id=\"BlogPostCategory\"></div><div id=\"EntryTag\"></div><div id=\"blog_post_info\"></div><div class=\"clear\"></div><div id=\"post_next_prev\"></div></div>        </div>      <div class = \"postDesc\">posted @ <span id=\"post-date\">2017-05-19 11:34</span> <a href='http://www.cnblogs.com/Alandre/'>泥瓦匠BYSocket</a> 阅读(<span id=\"post_view_count\">...</span>) 评论(<span id=\"post_comment_count\">...</span>)  <a href =\"https://i.cnblogs.com/EditPosts.aspx?postid=6877512\" rel=\"nofollow\">编辑</a> <a href=\"#\" onclick=\"AddToWz(6877512);return false;\">收藏</a></div>  </div>  <script type=\"text/javascript\">var allowComments=true,cb_blogId=149665,cb_entryId=6877512,cb_blogApp=currentBlogApp,cb_blogUserGuid='e899018c-3e95-e211-9010-c3d7423e3b07',cb_entryCreatedDate='2017/5/19 11:34:00';loadViewCount(cb_entryId);var cb_postType=1;</script> </div><!--end: topics 文章、评论容器--></div><a name=\"!comments\"></a><div id=\"blog-comments-placeholder\"></div><script type=\"text/javascript\">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script><div id='comment_form' class='commentform'><a name='commentform'></a><div id='divCommentShow'></div><div id='comment_nav'><span id='span_refresh_tips'></span><a href='javascript:void(0);' onclick='return RefreshCommentList();' id='lnk_RefreshComments' runat='server' clientidmode='Static'>刷新评论</a><a href='#' onclick='return RefreshPage();'>刷新页面</a><a href='#top'>返回顶部</a></div><div id='comment_form_container'></div><div class='ad_text_commentbox' id='ad_text_under_commentbox'></div><div id='ad_t2'></div><div id='opt_under_post'></div><div id='cnblogs_c1' class='c_ad_block'></div><div id='under_post_news'></div><div id='cnblogs_c2' class='c_ad_block'></div><div id='under_post_kb'></div><div id='HistoryToday' class='c_ad_block'></div><script type='text/javascript'>    fixPostBody();    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);    deliverAdT2();    deliverAdC1();    deliverAdC2();        loadNewsAndKb();    loadBlogSignature();    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate, cb_postType);    loadOptUnderPost();    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   </script></div>    </div><!--end: forFlow -->  </div><!--end: mainContent 主体内容容器-->    <div id=\"sideBar\">        <div id=\"sideBarMain\">            <!--done--><div class=\"newsItem\"><h3 class=\"catListTitle\">公告</h3>   <div id=\"blog-news\"></div><script type=\"text/javascript\">loadBlogNews();</script></div>         <div id=\"blog-calendar\" style=\"display:none\"></div><script type=\"text/javascript\">loadBlogDefaultCalendar();</script>                     <div id=\"leftcontentcontainer\">               <div id=\"blog-sidecolumn\"></div><script type=\"text/javascript\">loadBlogSideColumn();</script>           </div>                  </div><!--end: sideBarMain -->  </div><!--end: sideBar 侧边栏容器 -->    <div class=\"clear\"></div> </div><!--end: main --> <div class=\"clear\"></div> <div id=\"footer\">     <!--done-->Copyright &copy;2017 泥瓦匠BYSocket </div><!--end: footer --></div><!--end: home 自定义的最大容器 --></body></html>";
                // 进行过滤

                String times = filter.filter(HtmlUtil.getTextFromHtml(sentence));

                // 如果未过滤，则返回输入的String引用
                // if (sentence != filted) {
                // 句子中有敏感词
                logger.info("敏感词出现次数：{}", times);
                // }
                logger.info("iD：{}", idGenerater.nextId());

                return JsonEntity.makeSuccessJsonEntity(times);

            }
        } catch (Exception ex) {
            logger.error("error..............{}", ex);
        } finally {
            lock.unLock();
            logger.info("unlock.................");
        }

        return JsonEntity.makeSuccessJsonEntity(null);

    }
}
